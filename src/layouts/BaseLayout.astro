---
// src/layouts/BaseLayout.astro

import contributors from "../data/contributors.json"; // ★displayName解決用

interface Props {
  pageTitle?: string;
  subtitle?: string;
  showCanvas?: boolean;
  enableLinks?: boolean;
}

const {
  pageTitle = "KoLLOID",
  subtitle = "とけない個のための表現空間",
  showCanvas = true,
  enableLinks = false,
} = Astro.props;
---

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>{pageTitle}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- favicon（タブ・ブックマーク用） -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-v2.png" />

    {/* 粒子背景用の p5.js */}
    {showCanvas && (
      <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
    )}

    <style>
      body {
        margin: 0;
        min-height: 100vh;
        background: #f7f5f2;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #333;
      }

      /* ★PC/スマホ共通で「ロゴ → メニュー」を縦に積む */
      header.site-header {
        padding: 1.6rem 1.5rem 0.2rem;
        max-width: 960px;
        margin: 0 auto;
        margin-top: 2rem;

        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.55rem;

        height: auto;
        position: relative;

        /* ★粒子より前 */
        z-index: 20;
      }

      .site-title-link {
        position: static;
        transform: none;
        display: inline-flex;
        align-items: center;
        text-decoration: none;
      }

      .site-logo {
        height: 168px;
        width: auto;
        display: block;
        opacity: 0.92;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .site-title-link:hover .site-logo {
        opacity: 0.8;
        transform: translateY(-1px);
      }

      nav.site-nav {
        position: static;
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      nav.site-nav a {
        text-decoration: none;
        color: #666;
        font-size: 1.2rem;
        position: relative;
        transition: color 0.2s ease;
        padding: 0.1rem 0.05rem;
      }

      nav.site-nav a:hover {
        color: #333;
      }

      nav.site-nav a::after {
        content: "";
        position: absolute;
        left: 0;
        bottom: -0.2rem;
        width: 0;
        height: 1px;
        background: #999;
        transition: width 0.2s ease;
      }

      nav.site-nav a:hover::after {
        width: 100%;
      }

      @media (max-width: 600px) {
        header.site-header {
          padding: 1.6rem 1.2rem 0.2rem;
          margin-top: 2rem;
          gap: 0.45rem;
        }

        .site-logo {
          height: 84px;
        }

        nav.site-nav a {
          font-size: 1.1rem;
        }
      }

      main.page-main {
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem 1.5rem 3rem;
        text-align: center;

        position: relative;
        z-index: 10;
      }

      #canvas-container {
        position: fixed;
        inset: 0;
        z-index: 0;
      }

      .site-footer {
        margin-top: 3rem;
        padding: 1.5rem 0 2rem;
        text-align: center;
        font-size: 0.8rem;
        color: #777;

        position: relative;
        z-index: 10;
      }

      /* ===== スマホ：粒子情報の下部固定パネル ===== */
      #particle-panel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 30;

        display: none;
        padding: 0.9rem 1rem 1rem;

        background: rgba(255, 255, 255, 0.92);
        border-top: 1px solid rgba(0, 0, 0, 0.12);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
      }

      #particle-panel.is-open {
        display: block;
      }

      #particle-panel .inner {
        max-width: 960px;
        margin: 0 auto;
        text-align: left;
      }

      #particle-panel .row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 0.8rem;
      }

      #particle-panel .title {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        line-height: 1.4;
        margin: 0;
      }

      #particle-panel .meta {
        margin-top: 0.35rem;
        font-size: 0.85rem;
        color: #666;
        line-height: 1.5;
      }

      #particle-panel .actions {
        display: flex;
        gap: 0.55rem;
        align-items: center;
        flex-shrink: 0;
      }

      #particle-panel .btn {
        appearance: none;
        border: 1px solid rgba(0, 0, 0, 0.18);
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        border-radius: 999px;
        padding: 0.45rem 0.75rem;
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: none;
        white-space: nowrap;
      }

      #particle-panel .btn:hover {
        border-color: rgba(0, 0, 0, 0.28);
      }

      /* パネルが出てるとき、本文が隠れすぎないように余白 */
      body.has-particle-panel main.page-main {
        padding-bottom: 6.5rem;
      }

      @media (min-width: 801px) {
        /* PCでは基本使わない（hoverツールチップがある） */
        #particle-panel {
          display: none !important;
        }
        body.has-particle-panel main.page-main {
          padding-bottom: 3rem;
        }
      }
    </style>
  </head>

  <body data-show-canvas={showCanvas} data-enable-links={enableLinks}>
    {showCanvas && <div id="canvas-container"></div>}

    <header class="site-header">
      <a href="/" class="site-title-link" aria-label="KoLLOID">
        <img class="site-logo" src="/logo.png" alt="KoLLOID" />
      </a>

      <nav class="site-nav">
        <a href="/">KoLLOID</a>
        <a href="/guide">Guide</a>
        <a href="/about">About</a>
        <a href="/statement">Statement</a>
        <a href="/contributors">Contributors</a>
        <a href="/articles">Articles</a>
      </nav>
    </header>

    <main class="page-main">
      <slot />
    </main>

    {/* ★スマホ用：粒子情報パネル（enableLinks=true のページだけ使う） */}
    <div id="particle-panel" aria-live="polite">
      <div class="inner">
        <div class="row">
          <div>
            <p class="title" id="pp-title"></p>
            <div class="meta" id="pp-meta"></div>
          </div>

          <div class="actions">
            <a class="btn" id="pp-open" href="#" target="_blank" rel="noopener noreferrer">開く</a>
            <button class="btn" id="pp-close" type="button">閉じる</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="site-footer">© KoLLOID, 2025–</footer>

    {/* script は常に出す（showCanvas=false のページでも destroy できるように） */}
    <script
      type="module"
      is:inline
      define:vars={{ contributors }} /* ★contributorsをブラウザへ渡す */
    >
      import { createKolloidSketch } from "/js/kolloid-particles.js?v=2026-02-07-v3";

      function getFlags() {
        const root = document.body;
        const showCanvas = root.dataset.showCanvas === "true";
        const enableLinks = root.dataset.enableLinks === "true";
        return { showCanvas, enableLinks };
      }

      function isTouchDevice() {
        return ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);
      }

      function displayNameOf(contributorKey) {
        const key = (contributorKey || "").trim();
        return (contributors && contributors[key] && contributors[key].displayName) ? contributors[key].displayName : (contributorKey || "");
      }

      // ===== 粒子パネル制御 =====
      function closeParticlePanel() {
        const panel = document.getElementById("particle-panel");
        if (!panel) return;
        panel.classList.remove("is-open");
        document.body.classList.remove("has-particle-panel");
      }

      function openParticlePanel(item) {
        const panel = document.getElementById("particle-panel");
        if (!panel) return;

        const titleEl = document.getElementById("pp-title");
        const metaEl = document.getElementById("pp-meta");
        const openEl = document.getElementById("pp-open");

        const title = item?.title || "";
        const contributorName = displayNameOf(item?.contributor);
        const genre = item?.genre || "—";

        if (titleEl) titleEl.textContent = title;
        if (metaEl) metaEl.textContent = `制作者：${contributorName} / ジャンル：${genre}`;
        if (openEl) {
          openEl.href = item?.link || "#";
        }

        panel.classList.add("is-open");
        document.body.classList.add("has-particle-panel");
      }

      function hookParticlePanelEvents() {
        const closeBtn = document.getElementById("pp-close");
        if (closeBtn && !closeBtn.__kolloidBound) {
          closeBtn.addEventListener("click", closeParticlePanel);
          closeBtn.__kolloidBound = true;
        }
      }

      // particles.js から飛んでくるイベントを受ける
      function hookKolloidEvents() {
        if (window.__kolloidPanelHooked) return;
        window.__kolloidPanelHooked = true;

        window.addEventListener("kolloid:particle:select", (ev) => {
          const { enableLinks } = getFlags();
          if (!enableLinks) return;

          // PCでは表示しない（hoverツールチップがある）
          if (!isTouchDevice()) return;

          const item = ev?.detail?.item || null;
          if (!item) {
            closeParticlePanel();
            return;
          }
          openParticlePanel(item);
        });

        window.addEventListener("kolloid:particle:clear", () => {
          closeParticlePanel();
        });
      }

      // ===== p5 初期化/破棄 =====
      function destroySketch() {
        // パネルも閉じる（ページ遷移時の残留防止）
        closeParticlePanel();

        if (window.__kolloidP5__) {
          try {
            window.__kolloidP5__.remove();
          } catch (e) {
            console.warn("p5 remove failed:", e);
          }
          window.__kolloidP5__ = null;
        }

        const container = document.getElementById("canvas-container");
        if (container) container.innerHTML = "";
      }

      function initSketch() {
        const { showCanvas, enableLinks } = getFlags();

        hookParticlePanelEvents();
        hookKolloidEvents();

        destroySketch();
        if (!showCanvas) return;

        if (!window.p5) {
          console.warn("p5 is not loaded (showCanvas=true).");
          return;
        }

        window.__kolloidP5__ = new p5(
          createKolloidSketch({ enableLinks, contributorsMap: contributors })
        );
      }

      window.addEventListener("DOMContentLoaded", initSketch);

      document.addEventListener("astro:before-swap", destroySketch);
      document.addEventListener("astro:after-swap", initSketch);
      document.addEventListener("astro:page-load", initSketch);
    </script>
  </body>
</html>
