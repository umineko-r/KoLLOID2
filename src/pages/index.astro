---
import BaseLayout from "../layouts/BaseLayout.astro";
import fs from "node:fs/promises";
import path from "node:path";

const title = "KoLLOID";
const subtitle = "とけない個のための表現空間";
const explanation = `この空間には様々な個性をもった表現がふわふわと浮遊しています。
ぜひ好きな粒子を手にとって眺めてみてください。`;

// ★ 自動収集 + 手動管理 を合算して数える
const particlesPaths = [
  path.join(process.cwd(), "public", "data", "particles.json"),
  path.join(process.cwd(), "public", "data", "particles-m.json"),
];

type Particle = {
  id?: string;
  link?: string;
};

async function readParticlesSafe(filePath: string): Promise<Particle[]> {
  try {
    const raw = await fs.readFile(filePath, "utf-8");
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? (parsed as Particle[]) : [];
  } catch {
    return [];
  }
}

// 総数（重複は id || link で除外）
let totalCount = 0;

try {
  const lists = await Promise.all(particlesPaths.map(readParticlesSafe));
  const merged = lists.flat();

  const byKey = new Map<string, Particle>();
  for (const it of merged) {
    const key = (it?.id || it?.link || "").trim();
    if (!key) continue;
    // 同一キーは後勝ちでOK（表示数の目的なので）
    byKey.set(key, it);
  }

  totalCount = byKey.size;
} catch {
  // 生成前/未配置などでもトップは表示したいので握りつぶす
  totalCount = 0;
}
---

<BaseLayout pageTitle={title} subtitle={subtitle} enableLinks={true} showCanvas={true}>
  <section>
    <h2 style="font-size: 1.4rem; margin-bottom: 0.5rem;">
      {subtitle}
    </h2>

    <p
      style="
        white-space: pre-line;
        margin-top: 1.5rem;
        font-size: 0.95rem;
        color: #333;
      "
    >
      {explanation}
    </p>

    <p
      style="
        margin-top: 1.2rem;
        font-size: 0.85rem;
        color: #666;
      "
    >
      現在、{totalCount}種類の粒子の中から、いくつかがランダムに浮かび上がっています。
    </p>
  </section>
</BaseLayout>
