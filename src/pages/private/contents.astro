---
import BaseLayout from "../../layouts/BaseLayout.astro";
import contributors from "../../data/contributors.json";
import fs from "node:fs/promises";
import path from "node:path";

type Particle = {
  id?: string;
  contributor: string;
  title: string;
  link: string;
  genre?: string;
  siteType?: string;
  updatedAt?: string;
  account?: string; // Instagram用（あってもなくてもOK）
};

type Contributor = {
  displayName: string;
  genres?: string[];
  links?: Record<string, string>;
};

type ContributorsMap = Record<string, Contributor>;

type GroupBlock = {
  siteType: string;
  label: string;
  items: Particle[];
};

type ContributorBlock = {
  key: string;
  displayName: string;
  genres: string[];
  totalCount: number;
  latest: string | null;
  groups: GroupBlock[];
};

const pageTitle = "Contents | KoLLOID";
const contributorsMap = contributors as ContributorsMap;

// ★2ファイル読む
const baseDir = path.join(process.cwd(), "public", "data");
const particlesPaths = [
  path.join(baseDir, "particles.json"),     // 自動収集
  path.join(baseDir, "particles-m.json"),   // 手動（Instagramなど）
];

let particles: Particle[] = [];
let particlesReadOk = true;

async function readJsonArray(filePath: string): Promise<Particle[]> {
  try {
    const raw = await fs.readFile(filePath, "utf-8");
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? (parsed as Particle[]) : [];
  } catch (e) {
    console.warn("[contents] failed to read:", filePath, e);
    return [];
  }
}

try {
  const arrays = await Promise.all(particlesPaths.map(readJsonArray));
  const merged = arrays.flat();

  // ★id or link で重複排除（JS側と同じ思想）
  const byKey = new Map<string, Particle>();
  for (const p of merged) {
    const key = (p.id || p.link || "").trim();
    if (!key) continue;
    byKey.set(key, p);
  }

  particles = [...byKey.values()];
} catch (e) {
  console.warn("[contents] failed to read particles:", e);
  particles = [];
  particlesReadOk = false;
}

function normalizeSiteType(siteType?: string) {
  const s = (siteType || "").trim().toLowerCase();
  // ★blogger を blog に寄せる（任意）
  if (s === "blogger") return "blog";
  return s || "other";
}

function siteTypeLabel(siteType: string) {
  const map: Record<string, string> = {
    youtube: "YouTube",
    note: "note",
    instagram: "Instagram",
    blog: "Blog",
    blogger: "Blog",
    facebook: "Facebook",
    other: "Other",
  };
  return map[siteType] || siteType;
}

const preferredOrder = ["instagram", "note", "youtube", "blog", "facebook", "other"];

function sortSiteTypes(a: string, b: string) {
  const ia = preferredOrder.indexOf(a);
  const ib = preferredOrder.indexOf(b);
  if (ia !== -1 && ib !== -1) return ia - ib;
  if (ia !== -1) return -1;
  if (ib !== -1) return 1;
  return a.localeCompare(b);
}

// ★孤児検出
const knownKeys = new Set(Object.keys(contributorsMap));

const orphanParticles: Particle[] = particles
  .filter((p) => {
    const k = (p.contributor || "").trim();
    return k.length > 0 && !knownKeys.has(k);
  })
  .sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));

// ★表示用ブロック
const blocks: ContributorBlock[] = Object.entries(contributorsMap).map(
  ([key, contributor]) => {
    const items = particles
      .filter((p) => p.contributor === key)
      .sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));

    const latest = items[0]?.updatedAt || null;

    const grouped: Record<string, Particle[]> = {};
    for (const it of items) {
      const st = normalizeSiteType(it.siteType);
      (grouped[st] ||= []).push(it);
    }

    const siteTypes = Object.keys(grouped).sort(sortSiteTypes);

    const groups: GroupBlock[] = siteTypes.map((st) => {
      const list = grouped[st] ?? [];
      list.sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));
      return { siteType: st, label: siteTypeLabel(st), items: list };
    });

    return {
      key,
      displayName: contributor.displayName,
      genres: contributor.genres ?? [],
      totalCount: items.length,
      latest,
      groups,
    };
  }
);
---

<BaseLayout pageTitle={pageTitle} enableLinks={false} showCanvas={false}>
  <article style="text-align:left; max-width:760px; margin:0 auto;">
    <h2>Contents</h2>

    <p style="font-size:0.85rem; color:#777; margin:0 0 0.6rem;">
      contributors: {Object.keys(contributorsMap).length} / particles: {particles.length}
      {orphanParticles.length ? ` / orphan: ${orphanParticles.length}` : ""}
    </p>

    {!particlesReadOk ? (
      <p style="font-size:0.85rem; color:#a66; margin:0 0 0.6rem;">
        ※ particles が読み込めませんでした（未生成/未配置の可能性）。contributors の台帳のみ表示しています。
      </p>
    ) : null}

    <p style="font-size:0.85rem; color:#777; margin:0 0 1.5rem;">
      ※ このページは KoLLOID 運営用のコンテンツ一覧です（外部共有を前提にしていません）。
    </p>

    {blocks.map((b) => (
      <section style="margin-top:2.6rem;">
        <h3 style="margin:0 0 0.2rem;">
          {b.displayName}（{b.totalCount}件）
        </h3>

        <p style="font-size:0.85rem; color:#777; margin:0 0 0.6rem;">
          {b.latest ? `最終更新：${b.latest}` : "最終更新：—"}
        </p>

        {b.genres.length ? (
          <p style="font-size:0.85rem; color:#777; margin:0 0 1rem;">
            ジャンル：{b.genres.join(" / ")}
          </p>
        ) : null}

        {b.totalCount === 0 ? (
          <p style="font-size:0.9rem; color:#888; margin:0.2rem 0 0;">
            まだ登録がありません。
          </p>
        ) : (
          b.groups.map((g) => (
            <section style="margin:1.2rem 0 0;">
              <h4 style="margin:0 0 0.5rem; font-size:1rem;">
                {g.label}（{g.items.length}）
              </h4>

              <ul style="padding-left:1.2rem; margin:0;">
                {g.items.map((item) => (
                  <li style="margin-bottom:0.55rem;">
                    <a
                      href={item.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      style="text-decoration:underline;"
                    >
                      {item.title}
                    </a>

                    <span style="color:#777; font-size:0.85rem;">
                      {" "}
                      （{item.genre || "—"}
                      {item.updatedAt ? ` / ${item.updatedAt}` : ""}
                      ）{/* siteTypeを出したければここに追加 */}
                    </span>
                  </li>
                ))}
              </ul>
            </section>
          ))
        )}
      </section>
    ))}

    {orphanParticles.length ? (
      <section style="margin-top:3rem; padding-top:1.2rem; border-top:1px solid rgba(0,0,0,0.12);">
        <h3 style="margin:0 0 0.6rem; color:#a44;">
          Orphan particles（contributors未登録）
        </h3>

        <p style="font-size:0.85rem; color:#777; margin:0 0 1rem;">
          ※ particles に存在するが、contributors.json に contributor 定義がない項目です。
          contributorキーのタイポ、または contributors 側の追加漏れの可能性があります。
        </p>

        <ul style="padding-left:1.2rem; margin:0;">
          {orphanParticles.map((item) => (
            <li style="margin-bottom:0.6rem;">
              <div style="font-size:0.9rem;">
                <strong style="font-weight:600;">{item.contributor}</strong>{" "}
                —
                <a
                  href={item.link}
                  target="_blank"
                  rel="noopener noreferrer"
                  style="text-decoration:underline; margin-left:0.35rem;"
                >
                  {item.title}
                </a>
              </div>
              <div style="color:#777; font-size:0.85rem; margin-top:0.1rem;">
                {item.genre || "—"} / {item.siteType || "—"}
                {item.updatedAt ? ` / ${item.updatedAt}` : ""}
                {item.id ? ` / id:${item.id}` : ""}
              </div>
            </li>
          ))}
        </ul>
      </section>
    ) : null}
  </article>
</BaseLayout>