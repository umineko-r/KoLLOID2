---
import BaseLayout from "../layouts/BaseLayout.astro";
import contributors from "../data/contributors.json";

type Contributor = {
  displayName: string;
  genres?: string[];
  links?: Record<string, string>;
};

type Entry = [string, Contributor];

/* リンク表示名 */
const LINK_LABELS: Record<string, string> = {
  instagram: "Instagram",
  youtube: "YouTube",
  facebook: "Facebook",
  note: "note",
  threads: "Threads",
  x: "X",
};

/* contributors を分解 */
const entries = Object.entries(contributors) as Entry[];

// 主宰ID（固定）
const HOST_ID = "umineko";

// 主宰以外（SSRは安定順で出しておき、初回アクセス時にJSで並べ替える）
const others = entries
  .filter(([id]) => id !== HOST_ID)
  .sort((a, b) => a[0].localeCompare(b[0]));

// 主宰（固定表示）
const host = entries.find(([id]) => id === HOST_ID) ?? null;
---

<BaseLayout pageTitle="Contributors | KoLLOID" enableLinks={false} showCanvas={false}>
  <article style="max-width: 720px; margin: 0 auto; text-align: left;">
    <h2>Contributors</h2>

    <p style="font-size:0.85rem; color:#777; margin-top:0.3rem;">
      ※ 表示順は初回アクセス時に静かに決まります。
    </p>

    {/* 主宰以外：初回アクセス時に並べ替える（チラつき防止で最初は非表示） */}
    <div id="contributors-others" style="visibility:hidden;">
      {others.map(([id, c]) => (
        <section
          data-id={id}
          style="
            margin-top: 2.5rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
          "
        >
          <h3 style="margin-bottom: 0.4rem;">
            {c.displayName}
          </h3>

          {/* ジャンル */}
          {c.genres?.length ? (
            <p style="font-size: 0.9rem; color: #555; margin: 0.3rem 0;">
              ジャンル：{c.genres.join("／")}
            </p>
          ) : null}

          {/* リンク（横並び） */}
          {c.links ? (
            <div
              style="
                margin-top: 0.6rem;
                display: flex;
                flex-wrap: wrap;
                gap: 0.8rem 1.2rem;
                font-size: 0.9rem;
              "
            >
              {Object.entries(c.links).map(([key, url]) => {
                const label = LINK_LABELS[key] ?? key;
                return (
                  <a
                    href={url}
                    target="_blank"
                    rel="noopener noreferrer"
                    style="
                      color: #444;
                      text-decoration: underline;
                      white-space: nowrap;
                    "
                  >
                    {label}
                  </a>
                );
              })}
            </div>
          ) : null}
        </section>
      ))}
    </div>

    {/* 主宰：固定（最後に小さく） */}
    {host ? (
      <section style="margin-top: 2.2rem; padding-top: 0.2rem;">
        <h3 style="margin-bottom: 0.4rem; font-size: 1.05rem;">
          {host[1].displayName}
          <span
            style="
              margin-left: 0.5rem;
              font-size: 0.75rem;
              color: #888;
              font-weight: normal;
            "
          >
            （主宰）
          </span>
        </h3>

        {host[1].genres?.length ? (
          <p style="font-size: 0.85rem; color: #666; margin: 0.2rem 0;">
            ジャンル：{host[1].genres.join("／")}
          </p>
        ) : null}

        {host[1].links ? (
          <div
            style="
              margin-top: 0.5rem;
              display: flex;
              flex-wrap: wrap;
              gap: 0.7rem 1.1rem;
              font-size: 0.85rem;
              color: #666;
            "
          >
            {Object.entries(host[1].links).map(([key, url]) => {
              const label = LINK_LABELS[key] ?? key;
              return (
                <a
                  href={url}
                  target="_blank"
                  rel="noopener noreferrer"
                  style="
                    color: #444;
                    text-decoration: underline;
                    white-space: nowrap;
                  "
                >
                  {label}
                </a>
              );
            })}
          </div>
        ) : null}
      </section>
    ) : null}
  </article>

  {/* 初回アクセスだけシャッフル（主宰以外）
      - チラつき防止：並べ替え完了まで #contributors-others を非表示
      - contributors増減に追従：
          削除IDは落とす
          追加IDは「既存orderのランダム位置に挿入」して混ぜる
  */}
  <script is:inline>
    (function () {
      const STORAGE_KEY = "kolloid_contributors_order_v1";
      const root = document.getElementById("contributors-others");
      if (!root) return;

      const sections = Array.from(root.querySelectorAll("section[data-id]"));
      const ids = sections
        .map((el) => el.getAttribute("data-id"))
        .filter(Boolean);

      // 0-1件なら並べ替え不要（表示だけ戻す）
      if (sections.length <= 1) {
        root.style.visibility = "visible";
        return;
      }

      function shuffle(arr) {
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          const tmp = a[i];
          a[i] = a[j];
          a[j] = tmp;
        }
        return a;
      }

      // ★追加分をランダム位置に挿入
      function insertRandomly(base, additions) {
        const out = base.slice();
        const add = shuffle(additions);
        for (const id of add) {
          const idx = Math.floor(Math.random() * (out.length + 1)); // 0..len
          out.splice(idx, 0, id);
        }
        return out;
      }

      function applyOrder(order) {
        const byId = new Map();
        sections.forEach((el) => {
          const id = el.getAttribute("data-id");
          if (id) byId.set(id, el);
        });

        // 指定順に append（DOMの順番が変わる）
        order.forEach((id) => {
          const el = byId.get(id);
          if (el) root.appendChild(el);
        });

        // 並び替え完了後に表示
        root.style.visibility = "visible";
      }

      function safeParse(json) {
        try {
          return JSON.parse(json);
        } catch {
          return null;
        }
      }

      // 既存の保存順を読む
      let order = null;
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        const parsed = saved ? safeParse(saved) : null;
        if (Array.isArray(parsed)) {
          order = parsed.filter((x) => typeof x === "string");
        }
      } catch (e) {
        // 読めない場合は初回扱い
      }

      const currentSet = new Set(ids);

      // 初回（または壊れている）なら新規生成
      if (!order || order.length === 0) {
        order = shuffle(ids);
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(order));
        } catch (e) {
          // 保存できなくても表示だけ反映
        }
        applyOrder(order);
        return;
      }

      // 1) 削除されたIDを落とす
      order = order.filter((id) => currentSet.has(id));

      // 2) 追加されたIDを拾う
      const orderSet = new Set(order);
      const missing = ids.filter((id) => !orderSet.has(id));

      if (missing.length > 0) {
        // ★既存順に対して、追加分をランダム位置に挿入して混ぜる
        order = insertRandomly(order, missing);

        // 保存し直す（可能なら）
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(order));
        } catch (e) {
          // 保存できなくても表示だけ反映
        }
      }

      applyOrder(order);
    })();
  </script>
</BaseLayout>